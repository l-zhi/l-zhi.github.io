
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>生活中的树和程序中的树 | fanfan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="fanlizhi">
    
    <meta name="description" content="">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="fanfan" title="fanfan"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="fanfan">fanfan</a></h1>
				<h2 class="blog-motto">原来还可以这样</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">home</a></li>
					
						<li><a href="/archives">文章</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:l-zhi.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2013/09/07/e7-94-9f-e6-b4-bb-e4-b8-ad-e7-9a-84-e6-a0-91-e5-92-8c-e7-a8-8b-e5-ba-8f-e4-b8-ad-e7-9a-84-e6-a0-91/" title="生活中的树和程序中的树" itemprop="url">生活中的树和程序中的树</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://l-zhi.com" title="fanlizhi">fanlizhi</a>
    </p>
  <p class="article-time">
    <time datetime="2013-09-07T15:52:02.000Z" itemprop="datePublished">2013-09-07</time>
    更新日期:<time datetime="2015-05-09T04:38:20.000Z" itemprop="dateModified">2015-05-09</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
		</div>
		
		<p><a id="more"></a>程序其实都是来源于生活，程序只是把他抽象化了，所以聊程序中的树之前，我想先找一下自然中的实例，在我们的周围到处都是树，树是大自然各种物体自我展现的一种最有效也是最简洁的方式，能很容易聚集很多零散的个体（独树成林就是这个道理），或者分析杂乱的事物和一些复杂的模型 比如下面这些就是很常见的例子：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/tree_001/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/tree_001.jpg" alt="tree_001"></a><br>而对于互联网呢？树也能清楚的展示层级结构，而不会显得凌乱，菜单的树如果命名得当很容易引导用户找到自己想要的内容，最最关键的是能节省空间，使得菜单简洁，展示更多网站主要内容。所以树已经在你不经意中融入了你的生命里了，融入你的代码和设计里了。<br>下面是我们程序中最常见的树：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/tree_002/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/tree_002.jpg" alt="tree_002"></a><br>其实抽象起来他们都有共同点：<br>都有隶属关系和层级关系。程序来源于生活，现实生活中的用户体验比互联网发展的时间长太多了，所以多留意生活中的细节，对理解互联网的交互体验很有帮助的。刚好最近写到树结构的相关模块，虽然以前写过树结构但是这一次我想多思考一些细节和为什么，总结一些规律和想法，以及最后实现的方式。</p>
<p><a href="http://l-zhi.com/demo/%c9%fa%bb%ee%d6%d0%b5%c4%ca%f7%ba%cd%b3%cc%d0%f2%d6%d0%b5%c4%ca%f7/demo.html" target="_blank" rel="external">等不及了可以先看最后结果&gt;&gt;</a></p>
<p>我会从后台数据库到前端展示整个打通来讲如何组织这颗“树”的。<br>首先来说说我的应用场景：<br>这个模块是一个故事会的管理的导航。<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard8/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard8.png" alt="clipboard8">
</a><br>整个展现全都是用样式展现的没有用到任何图片，所以很适合洁癖群体使用。<br>首先得将一棵树进行抽象：<br>有两种节点，一种是叶子节点，一种是树杈节点。所以对应到数据库，会设计<br>pid isleaf 这两个字段，isleaf判断是不是叶子，pid（父id）来判断这个节点属于哪个节点的，根据这些就能完整的展现出一棵树，<br>比如有这样一组数据：<br>表： list<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/attachment/20130907215942/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/20130907215942.png" alt="20130907215942"></a><br>这些数据很清晰的能组成一颗树，如下。<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard9/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard9.png" alt="clipboard9"></a><br>叶子节点都是没有子节点的，他们在最下面（张无忌的故事，张三丰的故事，奋斗在深圳，都市言情），非叶子节点都有子节点，就是上图分叉的节点（故实会，武侠，都市，武当的故事）。</p>
<p>有坑请注意：开始建数据的时候我有考虑过去掉故事会这个节点，只要是pid为0的都是故实会，这种方式很多人在用（比如我的上家公司就这样干的），而且没什么问题，用着也很顺手。但是如果联想想到我们现实世界的实例，能找到没有树干的树吗？这么一想问题就迎刃而解了，故实会就是我们的树干，他也有非叶子节点的属性，所以故事会这个节点还是得加在数据中，其实问题不止这些，如果哪天不叫故事会了叫故事集，程序里面你得改很多地方，程序逻辑是不应该参杂数据在里面的，做到不依赖数据，这也是设计时需要考虑的基本原则。</p>
<p>好了后端的（数据）树出来了，下来就来思考我们前端展现的树。<br>上面画的图是我根据数据库里的数据然后通过思考画出来的树结构图，我们需要把这个大脑思考的过程用程序的方式模拟出来。但是我们大脑的思维是自上而下的，我们都是会先找到树干然后一层层的加树枝，而程序里面我们得从下而上，因为所有的节点理论上说都有一个父节点，但是如果自上而下用子节点标记（如cid），叶子节点都没有子节点，而且一个节点的子节点个数未知，存储还得以逗号隔开如：（id1，id2），判断起来情况比较多而且复杂。<br>所以我们得换种思路考虑，再回过头来看看程序中的树：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard5/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard5.png" alt="clipboard5"></a></p>
<div>所有三角形的部分都是节点，我们只需要知道每个节点下面都是什么不就完了？</div><br><div></div><br><div>是的，我们只需要知道每个非叶子节点下面的子节点就行了，这里有两种方式，一种实时请求数据的，就是点击节点得到id再跑去数据库查询pid = id 的所有节点，我觉得实在没太大必要，除非数据量太多，而且对效率，速度都要求不高的时候可以这么干，还有一种树，也是我觉得效率更高的一种树，就是一次请求下来所有的数据组成树，这样点击响应速度更快，而且服务器开销也小一些，做为前端第一个考虑的最重要的体验就是速度，中国的网速你懂的，用户如果点一下等几秒，估计会疯掉。</div><br><div style="display: none"><a href="http://www.customizedweightlossprogram.com/" title="customized fat loss program" target="_blank" rel="external">customized fat loss program</a></div><div>比如我上天猫发现是这样的，我网速慢可能是一个原因，但是这种异步请求的方式我实在是觉得不好，因为左边菜单鼠标滑过的时候就会展现右侧数据，如果不是异步请求直接展现出来了，我心理上会觉得这个网站速度很快，而且这么重要的数据，尽然不是第一次请求，我很难理解。</div><br><div>截图为证：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard11/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard11.png" alt="clipboard11"></a><br>还有天猫的登录模块：</div><br><div><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard12/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard12.png" alt="clipboard12"></a></div><br>我很好奇登录不尽快展现登陆框，而是优先展现一张图片，我有几次图片出来了，但登陆框出现加载失败。<br><br>因为是iframe对网页性能消耗较大，会经常出现iframe加载失败。那叫一个哭啊。（不知道具体为什么这么做，如果有人了解欢迎解惑！）<br>呀！跑题了，我们继续说树，光拿到数据还是不够的，首先我们需要对这些数据整理一下（整理成非叶子节点的集合，可以这么干）：<br>js代码如下：<br><pre>var list = {};<br>var cids = &#039;&#039;;<br>for(var i = 0, len = data.length; i &lt; len; i++){<br>    if(!list[data[i][ &#039;pid&#039; ]]){<br>        list[data[i][ &#039;pid&#039; ]] = [ data[i] ];<br>    }else{<br>        list[data[i][ &#039;pid&#039; ]].push(data[i]);<br>    }<br>}<br>console.dir(list);</pre><br>整理之后显示结果如下：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard13/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard13.png" alt="clipboard13"></a><br>（其实就是整理成了我们大脑的思维方式，自上而下的找子节点）。<br>点击就展现出下面的节点如：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/clipboard14/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/clipboard14.png" alt="clipboard14"></a><br>每一个节点会有一个click事件，点击找到上面id对应的数组，循环拼接dom，然后做展现。<br><br>树虽然展现成功了，但是紧接着我又遇到了问题，比如我点击节点“武侠”，我需要看到武侠下面的所有文章，其实这种情况也很普遍，也有必要的。如果我的数据是这样的：<br><a href="http://l-zhi.com/2013/09/%e7%94%9f%e6%b4%bb%e4%b8%ad%e7%9a%84%e6%a0%91%e5%92%8c%e7%a8%8b%e5%ba%8f%e4%b8%ad%e7%9a%84%e6%a0%91/attachment/20130907221354/" target="_blank" rel="external"><img src="http://l-zhi.com/wp-content/uploads/2013/09/20130907221354.png" alt="20130907221354"></a><br>根据这种需求，我第一个想到sql语句可以这么写<strong> SELECT <code>name</code> FROM <code>article</code> WHERE <code>list_id</code> in &#039;id1,id2,id3,id4&#039;;</strong><br>我只要找到这些id就行了，再一思考我只要找到所有节点下的叶子节点就行了，一个递归就能搞定了，于是又有了下面的这段代码。<br><pre>_getCid : function(id){<br>    if(id &lt; 0) return;<br>    var list = this.list[id];<br>    if(!list) return;<br>    for(var i = 0, len = list.length; i &lt; len; i++){<br>        if(list[i][&#039;isleaf&#039;] == 1){<br>            this.cids += list[i][ &#039;id&#039; ] + &#039;,&#039;;<br>        }else{<br>            arguments.callee.call(this, list[i][ &#039;id&#039; ]);<br>        }<br>    }<br>}</pre><br>this.cids 是我们的组件对象，可能这里看不明白，下面我会给出组件的源码，下下来整个看就明白了。<br>最后完成的实例是这样的： <a href="http://l-zhi.com/demo/%c9%fa%bb%ee%d6%d0%b5%c4%ca%f7%ba%cd%b3%cc%d0%f2%d6%d0%b5%c4%ca%f7/demo.html" target="_blank" rel="external">疯狂的戳点这里查看树&gt;&gt;</a><br><br>这样终于算是完成了一棵树的完整展现了。其实我遇到的问题还远不止这些。<br>这是ajax的一个树结构展现，不用刷新页面，所以js可以用变量来存储列表数据。<br>但是还有一种需求无法避免，就是后台也会需要这种展现，而且每次点击会刷新页面（比如多级导航），所以我们得保存列表数据在服务器内存里，但是怎么保存呢？如果每次都读取数据库显然不太好，毕竟可能数据都是一样的，所有人都重复请求同样的数据，这事作为一个程序员的我来说是不能忍受的。所以我用了服务器缓存技术，来存贮列表，当列表数据变动的时候我才去更新缓存。<br><br>下面是完整demo的下载地址：<br><a href="http://l-zhi.com/demo/%c9%fa%bb%ee%d6%d0%b5%c4%ca%f7%ba%cd%b3%cc%d0%f2%d6%d0%b5%c4%ca%f7/ltree.rar" target="_blank" rel="external">下载地址&gt;&gt;</a><br><a href="http://l-zhi.com/demo/%c9%fa%bb%ee%d6%d0%b5%c4%ca%f7%ba%cd%b3%cc%d0%f2%d6%d0%b5%c4%ca%f7/demo.html" target="_blank" rel="external">下载之前看看这是不是你想要的&gt;&gt;</a><br><br>没有用图片用样式和字符模拟的树结构，速度很快哦！<br><br>原创文章，可随意转载，但是请注明出处，感谢支持！<br><br>文章地址：<a href="http://l-zhi.com/2013/09/%E7%94%9F%E6%B4%BB%E4%B8%AD%E7%9A%84%E6%A0%91%E5%92%8C%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E6%A0%91/" target="_blank" rel="external">生活中的树和程序中的树</a> <div style="display: none">zp8497586rq</div>  
	</div>
		<footer class="article-footer clearfix">


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/交互体验/">交互体验</a>►<a class="article-category-link" href="/categories/交互体验/前端技术/">前端技术</a>►<a class="article-category-link" href="/categories/交互体验/前端技术/原创/">原创</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://l-zhi.com/2013/09/07/e7-94-9f-e6-b4-bb-e4-b8-ad-e7-9a-84-e6-a0-91-e5-92-8c-e7-a8-8b-e5-ba-8f-e4-b8-ad-e7-9a-84-e6-a0-91/" data-title="生活中的树和程序中的树 | fanfan" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2013/10/05/e5-86-85-e8-81-94-e5-85-83-e7-b4-a0-e7-9a-84-e7-a9-ba-e9-9a-99/" title="内联元素的空隙">
  <strong>PREVIOUS:</strong><br/>
  <span>
  内联元素的空隙</span>
</a>
</div>


<div class="next">
<a href="/2013/08/31/e6-80-8e-e4-b9-88-e6-8b-af-e6-95-91-e4-bd-a0-ef-bc-8c-e6-88-91-e7-9a-84-e6-a0-b7-e5-bc-8f/"  title="怎么拯救你，我的样式">
 <strong>NEXT:</strong><br/> 
 <span>怎么拯救你，我的样式
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/交互体验/" title="交互体验">交互体验<sup>1</sup></a></li>
		
			<li><a href="/categories/前端技术/" title="前端技术">前端技术<sup>12</sup></a></li>
		
			<li><a href="/categories/交互体验/前端技术/" title="前端技术">前端技术<sup>1</sup></a></li>
		
			<li><a href="/categories/前端技术/原创/" title="原创">原创<sup>8</sup></a></li>
		
			<li><a href="/categories/原创/" title="原创">原创<sup>2</sup></a></li>
		
			<li><a href="/categories/交互体验/前端技术/原创/" title="原创">原创<sup>1</sup></a></li>
		
			<li><a href="/categories/原创/我所理解的生活/" title="我所理解的生活">我所理解的生活<sup>2</sup></a></li>
		
			<li><a href="/categories/未分类/" title="未分类">未分类<sup>2</sup></a></li>
		
			<li><a href="/categories/前端技术/翻译/" title="翻译">翻译<sup>3</sup></a></li>
		
		</ul>
</div>


  

  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">www.l-zhi.com All Rights Reserved 2013© 鄂ICP备13011210号 © 2015 
		
		<a href="http://l-zhi.com" target="_blank" title="fanlizhi">fanlizhi</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
